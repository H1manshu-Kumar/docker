###############
# STAGE 1 - Build Stage #
###############
# Use Maven with Eclipse Temurin JDK 21 on Alpine â€” lightweight for building Java apps
FROM maven:3.9-eclipse-temurin-21-alpine AS build

# Set working directory inside the builder container
WORKDIR /workspace

# Copy dependency descriptor first for better layer caching
COPY pom.xml ./

# Copy application source code
COPY src ./src

# Build the application and create the JAR file
RUN mvn clean package

###############
# -  STAGE 2  - Runtime Stage (Distroless) #
###############
# Use Distroless Java 21 runtime for maximum security (no shell, minimal OS)
FROM gcr.io/distroless/java21-debian12

# Application directory in the runtime container
WORKDIR /app

# Copy the packaged JAR from the build stage
COPY --from=build /workspace/target/java-app-1.0.0.jar /app/app.jar

# Expose port for the running application
EXPOSE 8000

# Run the application using Distroless entrypoint style
CMD ["app.jar"]

